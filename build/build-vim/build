#!/bin/zsh

BUILD_DIR=${0:A:h:h}
VIM_SOURCE_DIR=${BUILD_DIR}/source/vim
VIM_TARGET_DIR=${BUILD_DIR}/target
VIM_BIN_DIR=${BUILD_DIR}/bin

function get_source () {
    (
        if [ ! -e ${VIM_SOURCE_DIR} ]
        then
            git clone https://github.com/b4winckler/vim.git ${VIM_SOURCE_DIR}
        else
            cd ${VIM_SOURCE_DIR} && git pull
        fi
    )
}

function prepare_source () {
    (
        cd ${VIM_SOURCE_DIR}

        # Clean any changes from previous attempts to build
        for file in $(git status --porcelain | awk ' { print $2 } ')
        do
            ( git checkout ${file} || rm ${file} ) 2>&1 >/dev/null
        done

        # prefix is the location to put the result of building vim.
        # exec_prefix is the location to put the executable links.
        echo "
prefix = ${VIM_TARGET_DIR}
exec_prefix = ${VIM_BIN_DIR}" | cat Makefile - > Makefile.tmp && mv Makefile{.tmp,}
    )
}

function build () {
    (
        cd ${VIM_SOURCE_DIR}

        ./configure   &&
            make      &&
            make test &&
            make install
    )
}

get_source && prepare_source && build

# vim: set ai et sw=4 syntax=zsh :
