#!/bin/zsh

BUILD_DIR=${0:A:h:h}
VIM_SOURCE_DIR=${BUILD_DIR}/source/vim
VIM_TARGET_DIR=${BUILD_DIR}/target
VIM_BIN_DIR=${BUILD_DIR}/bin

function get_source () {
    (
        if [ ! -e ${VIM_SOURCE_DIR} ]
        then
            git clone https://github.com/b4winckler/vim.git ${VIM_SOURCE_DIR}
        else
            cd ${VIM_SOURCE_DIR} && git pull
        fi
    )
}

function prepare_source () {
    (
        cd ${VIM_SOURCE_DIR}

        # Clean any changes from previous attempts to build
        for file in $(git status --porcelain | awk ' { print $2 } ')
        do
            ( git checkout ${file} || rm ${file} ) 2>&1 >/dev/null
        done
    )
}

function do_configure () {
    # prefix is the location to put the result of building vim.
    # exec_prefix is the location to put the executable links.
    ./configure \
        --prefix=${VIM_TARGET_DIR} \
        --exec-prefix=${VIM_BIN_DIR} \
        --enable-perlinterp \
        --enable-pythoninterp \
        --enable-multibyte \
        --enable-fontset
}
function build () {
    (
        cd ${VIM_SOURCE_DIR}

        do_configure  &&
            make      &&
            make test &&
            make install
    )
}

get_source && prepare_source && build

# vim: set ai et sw=4 syntax=zsh :
